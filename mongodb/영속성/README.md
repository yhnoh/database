
### 저널링을 통한 영속성
- 몽고DB는 저널(journal)이라는 로그선행기입(WAL: write-ahead log)을 사용한다.
  - 데이터베이스 자체에 변경사항을 적용하기 전에 디스크에 먼저 변경사항을 작성한다.
  - 해당 변경사항을 미리 작성함으로써 서버가 갑자기 중지되어 재시작할 때, 저널 파일을 이용하여 데이터베이스 변경사항을 다시 작성한다.
  - 변경사항이 데이터베이스에 적용되어 영속성을 가지게되면(새로운 체크포인트) 오래된 저널 파일을 유지할 이유가 없기 때문에 자동으로 삭제된다.

> [MongoDB > 저널링](https://www.mongodb.com/ko-kr/docs/manual/core/journaling/)

### 쓰기결과확인을 통한 영속성
- WriteConcern은 쓰기 결과를 확인한 이후 변경사항을 적용할지 말지를 결정할 수 있다.
- WriteConcern을 결정하는 요소
  - w: 쓰기 작업이 성공했다고 판단하기 위한 복제본 수
  - j: true/false를 통해서 저널 파일의 기록 여부를 통하여 변경사항 적용 결정
  - wtiemout: 지정한 시간내에 쓰기 작업이 완료되지 않으면 오류를 반환
- WriteConcern 예제를 통하여 파악
    ```mongodb
    db.orders.insertOne(
        {name: "상품1", quantity: 3},
        {writeConcern: {w: "majority", wtimeout: 1000, j: true}}
    )
    ```
    - 해당 쓰기 작업이 데이터베이스에 정상적으로 반영되기 위해서는 아래 세가지 조건이 만족되어야한다.
      - 과반수 이상의 복제본에 데이터 반영
      - 저널 파일에 반영
      - 위 두 행위가 1초 이내에 반영
- 트랜잭션과 쓰기결과확인을 통하여 다중 도큐먼트 원자성 보장하기
  - 몽고 DB에서는 개별 도큐먼트 갱신에 대한 작업은 원자적이다.
  - 하지만 다중 도큐먼트에 대한 원자성이 필요한 경우가 있다.
  - 이러한 기능을 지원하기 위해서 트랜잭션수준의 WriteConcern을 제공하여 다중 도큐먼트 갱신에 대한 원자성을 보장할 수 있다.

> [MongoDB > WriteConcern](https://www.mongodb.com/ko-kr/docs/manual/reference/write-concern/) <br/>
> [MongoDB > Transaction](https://www.mongodb.com/ko-kr/docs/manual/core/transactions/)


- 복제셋에 쓰기 작업 진행시 모든 복제된 컬렉션의 데이터에 대해 몽고DB는 저널항목을 생성
  - 작업 로그를 기반으로하는 명령문 기반 복제
- 서버가 갑자기 중지되면서 재시작할 때 저널을 사용함으로써 종료 전에 디스크에 플러시되지 않은 쓰기를 다시 진행할 수 있다.
- 몽고DB는 dbPath 디렉터리에 journal이라는 서브 디렉터리를 만든다.
  - 저널 파일의 크기 제한은 약 100메가바이트이며, 크기 제한을 초과하면 몽고DB는 새 저널 파일을 만들고 거기에 다시 작성한다.
  - 오래된 저널파일은 자동으로 제거

- 몽고DB에서 개별 도큐먼트에 대한 작업은 원자적이다. 많은 애플리케이션에서 다중 도큐먼트 트랜잭션이 필요하지 않다.
- 여러 도큐먼트를 갱신할 때 원자성이 필요한 경우가 있으므로 몽고DB는 복제셋에 대해 다중 다큐먼트 트랜잭션을 수행하는 기능을 제공한다.
  - 트랜잭션을 사용하면 트랜잭션 내의 모든 데이터 변경이 성공해야하며, 실패하면 트랜잭션이 중단되고 모든 데이터 변경사항은 롤백된다.

### 클러스터 수준에서의 영속성 보장

- 쓰기결과확인을 통한 영속성 보장
  - 쓰기가 복제셋 멤버 대부분에 성공적으로 복제되었을 때만 쓰기가 성공적으로 완료됨을 서버로부터 확인받고자 함을의미